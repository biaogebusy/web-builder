import { Meta } from "@storybook/blocks";

<Meta title="开发/部署/SSH" id="ssh" />

通过SSH来拉取代码库和github actions自动部署

# 添加SSH Keys到版本库配置

## 复制公钥

到版本库的管理配置页面添加SSH Key

```
cat ~/.ssh/id_rsa.pub
```

## 如果没有则重新生成

```
ssh-keygen -t rsa -C "your_email@example.com"
```

# Github Actions 自动部署流程

## 生成新的SSH密匙对

如果没有则需要新生成

```
ssh-keygen -t ed25519 -C "your_email@example.com"
```

## 添加SSH私钥到ssh-agent中：

```
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_ed25519
```

## 检查配置文件

确保你的 SSH 配置文件（通常位于 ~/.ssh/config）正确设置了代码库的主机名和对应的私钥路径。

```
Host gitlab.com
       IdentityFile ~/.ssh/id_ed25519
```

## 测试SSH连接

```
ssh -T git@gitlab.com
```

> 注意：在使用GitHub actions部署时，需要关闭密码认证，只需要密匙认证，在1panle管理面板中，主机-》SSH管理可关闭密码任何和查看ED25519密匙。

```
name: Build app and deploy to ECS

on:
  push:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./
    steps:
      - name: work around permission issue
        run: git config --global --add safe.directory *

      - name: Checkout
        uses: actions/checkout@v3.0.1

      - name: use Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "20"

      - name: Cache verify
        run: npm cache verify

      - name: NPM Install
        run: npm ci over npm

      - name: NPM Install Angular
        run: npm install -g @angular/cli > /dev/null

      - name: NPM build all App Production
        run: npm run build

      - name: Deploy to Server
        uses: AEnterprise/rsync-deploy@v1.0.2
        env:
          DEPLOY_KEY: ${{ secrets.KEY }}
          ARGS: -avz --delete
          SERVER_PORT: "22"
          FOLDER: "dist"
          SERVER_IP: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.SSH_USER }}
          SERVER_DESTINATION: "/mnt/wwwroot/app/builder"

```
