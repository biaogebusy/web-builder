import { Meta } from "@storybook/addon-docs";

<Meta
  title="开发/部署/1panel "
  id="1panel"
  parameters={{
    viewMode: "docs",
    previewTabs: {
      canvas: { hidden: true },
    },
    layout: "fullscreen",
  }}
/>

# 部署 Angular 到 1panel

1Panel 是新一代基于 docker 的 Linux 服务器运维管理面板。

## 本地打包

使用命令`npm run build:ssr` 打包应用，打包成功后会生成`dist`目录，把`dist`目录和根目录的`package.json` 上传到 1panel。

## 在 1panel 中新建 node 运行环境

<img
  src="/assets/storybook/assets/1panel-node.png"
  alt="1panel-node"
  width="85%"
/>

如上图所示：

1. 源码目录是你自己创建的应用目录，其中包含了上传的 dist 目录和 package.json 文件。
2. 启动命令选择 package.json 中的 server:ssr；
3. 端口根据你的 environment.prod.ts 配置来设置；

## 创建反向代理

此时应用还不能通过外部域名访问，需要绑定域名并反向代理到 node 应用，进入网站，创建网站，选择反向代理。

<img
  src="/assets/storybook/assets/1panel-proxy.png"
  alt="1panel-node"
  width="85%"
/>

1. 填写绑定的域名；
2. 代理地址填写 node 的应用地址及端口；

需要注意的事，默认创建的反向代理需要更新成：

```nginx
location / {
    proxy_pass http://127.0.0.1:4211;
    proxy_set_header Host $host:$server_port;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header REMOTE-HOST $remote_addr;
    add_header X-Cache $upstream_cache_status;
    proxy_set_header X-Host $host:$server_port;
    proxy_set_header X-Scheme $scheme;
    proxy_connect_timeout 30s;
    proxy_read_timeout 86400s;
    proxy_send_timeout 30s;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
```

### 注意

当你的站点需要使用前台通过 api 登录等操作异常时，可能是由于 cors 的配置导致请求失败，可将 cors 的 exposedHeaders 设置为 false.

## 新增 Drupal 反向代理

当访问例如 drupal 的 api 或者 sites 文件时，则反向代理到 Drupal 的域名，完整如下：
http://127.0.0.1:8080 这个是 Drupal 的内网地址；

```ngxin
location ~* ^/(editor|batch|views/ajax|entity_reference_autocomplete|taxonomy/([^/]+)/([^/]+)/edit|autocomplete|media-library|history|quickedit|webform_rest|session|contextual|themes|shs-term-data|modules|libraries|core|api|user|admin|manage|system|print|export|sites/([^/]+)/files) {
    proxy_pass http://127.0.0.1:8080;
    proxy_redirect off;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host $server_name;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Port 443;
    proxy_read_timeout 240;
    # proxy_cache xinshi;
    # 要求nginx刷新内容时使用条件请求
    proxy_cache_revalidate on;
    # 访问几次才被缓存，可以确保最常访问的添加到项目中
    proxy_cache_min_uses 1;
    # 有效时间
    # 当后端故障时，提供缓存文件
    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    proxy_cache_background_update on;
    # 多个客户端请求缓存是miss,则仅允许第一个去去最新的数据，等缓存更新时，再去提取最新的缓存文件，可以防止未命中的直接发送后台
    proxy_cache_lock on;
    proxy_cache_methods GET HEAD;
    # 不缓存私有数据，url带有no_cache的也忽略
    proxy_cache_bypass $http_x_boost_fetch $arg_nocache $arg_preview $arg_no_cache $cookie_nocache;
    # nginx 当包含Expires没过期或者cache-control 带有private,no-cache,no-store, set-Cookies默认不会缓存响应
    # 检测缓存
    add_header X-Proxy-Cache $upstream_cache_status;
    proxy_buffering on;
    proxy_set_header Host admin.auooa.com;
    add_header Strict-Transport-Security "max-age=31536000";
    add_header Cache-Control no-cache;
}
location / {
    proxy_pass http://127.0.0.1:4211;
    proxy_set_header Host $host:$server_port;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header REMOTE-HOST $remote_addr;
    add_header X-Cache $upstream_cache_status;
    proxy_set_header X-Host $host:$server_port;
    proxy_set_header X-Scheme $scheme;
    proxy_connect_timeout 30s;
    proxy_read_timeout 86400s;
    proxy_send_timeout 30s;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
```
