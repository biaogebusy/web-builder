import { Meta } from "@storybook/addon-docs";

<Meta
  title="开发/用户认证/会话认证"
  id="session"
  parameters={{
    viewMode: "docs",
    previewTabs: {
      canvas: { hidden: true },
    },
    layout: "fullscreen",
  }}
/>

# Session Authentication 会话认证

会话认证（Session Authentication）是一种在客户端与服务器之间维护认证状态的机制。以下是对会话认证的详细介绍：

## 会话认证的基本原理

1. 用户登录：用户通过前端应用向服务器发送登录请求，通常包含用户名和密码。
2. 服务器验证：服务器验证用户的凭证。如果验证成功，服务器会创建一个会话（Session）对象，通常存储在服务器的内存或数据库中。
3. 会话 ID 生成：服务器生成一个唯一的会话 ID，作为会话的标识符。
4. 会话 ID 发送给客户端：服务器通过设置一个带有会话 ID 的 cookie 发送给客户端。这个 cookie 会包含会话 ID，并且通常会设置成 HttpOnly 以增加安全性。
5. 后续请求：在客户端的后续请求中，浏览器会自动包含这个 cookie，服务器通过检查这个会话 ID 来识别并验证用户的身份。
6. 会话管理：服务器会在内存或数据库中维护会话信息，包括会话的创建时间、用户数据等。会话有时会设置一个有效期，当会话过期后，用户需要重新登录。

## 会话认证的流程

1. 用户登录请求

- 客户端发送 POST 请求到服务器的登录端点，包含用户名和密码。
- 服务器验证凭证，如果成功，创建会话并生成会话 ID。

2. 服务器响应

- 服务器在响应中设置一个包含会话 ID 的 cookie。这个 cookie 会自动存储在客户端，并在后续请求中自动发送回服务器。

3. 后续请求处理

- 客户端发送后续请求时，浏览器会自动包含会话 ID 的 cookie。
- 服务器通过读取 cookie 中的会话 ID 来查找对应的会话，验证用户身份。

## 示例

### 用户登录请求

客户端（使用 JavaScript）发送登录请求：

```javascript
fetch("https://your-drupal-site.com/user/login?_format=json", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    name: "username",
    pass: "password",
  }),
  credentials: "include", // 确保会话 cookie 被发送
})
  .then((response) => response.json())
  .then((data) => {
    if (data.current_user) {
      console.log("Logged in as:", data.current_user.name);
    }
  })
  .catch((error) => console.error("Error:", error));
```

## 后续请求

在用户登录后，客户端可以发送带有会话 cookie 的请求：

```javascript
fetch("https://your-drupal-site.com/some-endpoint", {
  method: "GET",
  credentials: "include", // 确保会话 cookie 被发送
})
  .then((response) => response.json())
  .then((data) => console.log(data))
  .catch((error) => console.error("Error:", error));
```

## 优点和缺点

优点：

- 简单易实现，特别是在同一个域名或子域名下。
- 可以通过服务器端管理会话，灵活控制会话有效期和过期时间。

缺点：

- 不适用于跨域请求（可以使用 CORS 和第三方 cookie 解决）。
- 服务器需要维护会话状态，增加了服务器的存储和管理开销。
- 在分布式系统中，需要处理会话共享和同步的问题。

## 总结

会话认证是一种传统且广泛使用的用户认证机制。它通过在服务器端维护会话状态，并在客户端通过 cookie 传递会话 ID 来实现用户认证。会话认证简单且易于实现，但需要在实现跨域请求和分布式系统时进行额外配置和管理。
