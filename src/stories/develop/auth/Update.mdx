import { Meta } from '@storybook/blocks';

<Meta title="开发/用户接口/更新" id="update" />

## 使用 JSONAPI 更新用户信息

```
PATCH {{apiUrl}}/api/v1/user/user/{{uuid}}
'Accept': 'application/vnd.api+json'
'Content-Type': 'application/vnd.api+json'
'X-CSRF-Token': {{csrfToken}}

{
    "data": {
        "type": "user--user",
        "id":{{uuid}},
        "attributes": {
            "name": "johnson",
            "full_name": "johnson"
        }
    }
}
```

需要注意的是，如果需要更新类似邮箱等信息时，需要提供当前的用户密码，否则会返回：

```
[
    {
        "title": "Unprocessable Entity",
        "status": "422",
        "detail": "pass: 你当前的密码丢失或不正确，要求更改 密码。",
        "source": {
            "pointer": "/data/attributes/pass"
        }
    },
    {
        "title": "Unprocessable Entity",
        "status": "422",
        "detail": "mail: 你当前的密码丢失或不正确，要求更改 电子邮件。",
        "source": {
            "pointer": "/data/attributes/mail"
        }
    }
]
```

而提供当前的用户密码的格式是：

```
{
    "data": {
        "type": "user--user",
        "id": {{uuid}},
        "attributes": {
            "name": "johnson",
            "full_name": "johnson",
            "mail": "youremail@domain.com",
            "pass": {
                "existing": "xxx"
            }
        }
    }
}
```

## 使用 Drupal REST API 更新用户(D10将弃用 HAL)

进入：/admin/config/services/rest 开启用户并根据需要配置：
![module](/assets/storybook/assets/drupal/user-update.png)

```
### update user
PATCH {{apiUrl}}/user/119?_format=hal_json
Content-Type: application/hal+json
X-CSRF-Token: {{token}}

{
  "_links": {
    "type": {
     "href": "{{apiUrl}}/rest/type/user/user"
  }
  },
  "name":[{ "value" : "johnsonss" }],
  "mail":[{ "value" : "johnsonss@qq.com" }],
  "pass":[{"value":"654321"}]
}

```

更新用户资料的流程：

1. 用户登录后通过 api（/session/token） 可以获取 token：

```
GET {{apiUrl}}/session/token
content-type: application/json
```

2. 携带 token 和 cookies 更新对应的用户信息，更新哪项就提交哪项：

```
### update user
PATCH {{apiUrl}}/user/119?_format=hal_json
Content-Type: application/hal+json
withCredentials: true
X-CSRF-Token: 0tqSQmpQKzfOu43U5ufO6dTU9hGdajPXmCKRbKuvTi8

{
  "_links": {
    "type": {
     "href": "{{apiUrl}}/rest/type/user/user"
  }
  },
  "mail":[{ "value" : "hi@qq.com" }],
}

```

3. 更新微信用户的资料
   和 drupal 用户一样，也是需要 token 和 cookies：

```
### update wechat user
PATCH {{apiUrl}}/entity/wechat_user/15?_format=hal_json
Content-Type: application/hal+json
withCredentials: true
X-CSRF-Token: 6G4y09P_6SxE1wuQh_UMdhEq-I6-aQ9_mGFTs9SEnFs

{
  "_links": {
    "type": {
     "href": "{{apiUrl}}/rest/type/wechat_user/wechat_user"
  }
  },
  "nickname":[{ "value" : "johnson" }],
  "headimgurl":[{ "value" : "https://thirdwx.qlogo.cn/mmopen/vi_32/1b820GreUob15yeicXA8alyZbjoibIMSHPmDnaZwHnVrn4tQP3nPwYMXgu1diaicfRnpBvpNy8DcBajsfQuicmPJtGA/132" }]
}

```
