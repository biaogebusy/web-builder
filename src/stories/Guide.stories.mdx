import { Meta } from "@storybook/addon-docs";

<Meta title="开发指南" id="guide" />

# 开始开发

## environment 开发环境设置

```javascript
export const environment: IEnvironment = {
  apiUrl: "http://localhost:4200",
  production: false,
  site: "dist",
  port: 4200,
  cache: false,
  ssr: false,
  drupalProxy: false,
};
```

- apiUrl: 是整个应用的 Base api 参数；
- production: 为 false 时，页面的内容 api 将调用本地 json 文件，`${this.apiUrl}/assets/app${this.pageUrl}.json`，true 时将会调用`${this.apiUrl}/api/v1/landingPage?content=${this.pageUrl}`接口；
- site: prod 打包时生成的文件夹名称，此设置是为了生存多个站点项目；
- port: 自定义应用端口；
- cache: 是否开启 api 请求缓存；
- ssr: 是否使用 SSR 服务端渲染方式；
- drupalProxy: 对应后端为 drupal，统一使用 Drupal 来登录登出；

## 路由守卫配置

默认会读取 `/api/v1/config` 的全局配置信息，这里主要是查看该站点是否是开放还是需要登录的，文件路径`src/app/core/guards/auth.guard.ts`，本地开发时可注释掉大概 35 行`reture true；`；

## 代理

配置文件`config/proxy.config.js`，本地开发时，会根据对应的 api url 前缀进行代理转发，根据实际情况进行配置；

```javascript
const PROXY_CONFIG = [
  {
    context: ["/api", "/user", "/sites"],
    target: "https://api.zhaobg.com",
    secure: false,
    changeOrigin: true,
  },
];

module.exports = PROXY_CONFIG;
```

## 运行

`npm start`

## 为生产环境打包

`npm run build:ssr`

## 运行 Storybook

`npm run storybook`

> 如果有提示内存不足的报错，可在命令行执行`export NODE_OPTIONS="--max-old-space-size=8192"`，然后重新运行。

## 为项目运行指定不同的 NODE 版本

有时候，前端会有不同的项目，有些项目依赖的 node 版本不一致，可以使用[nvm 版本管理器](https://github.com/nvm-sh/nvm)切换。

- 安装脚本
  `curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.2/install.sh | bash`
  或者
  `wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.2/install.sh | bash`
  会自动下载并执行脚本：

  - 克隆一个版本库到`~/.nvm`
  - 在添加(~/.bash_profile, ~/.zshrc, ~/.profile, or ~/.bashrc)添加环境变量
    `export NVM_DIR="$([ -z "${XDG_CONFIG_HOME-}" ] && printf %s "${HOME}/.nvm" || printf %s "${XDG_CONFIG_HOME}/nvm")" [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" # This loads nvm`

- 关闭命令行窗口，重新打开，如果遇到报错，输入：`command -v nvm`
- 确定好你的环境变量的文件位置：`source ~/.baserc`

## 相关资源

- [Storybook 官网](https://storybook.js.org)
- [play test query](https://testing-library.com/docs/queries/about)
- [10 项最严重的开放 web 应用程序安全风险](https://owasp.org/www-project-top-ten)
