import { Meta } from '@storybook/blocks';

<Meta title="部署/Nginx 配置" id="nginx" />

## Nginx 配置

### 访问前台域名时代理转发给NODE

当用户通过浏览器访问页面时，Nginx 代理转发给Web builder（node）4200 端口进行处理，4200端口就是web builder 前端npm run builder 生成的包。

```shell
location / {
    proxy_pass http://127.0.0.1:4200;
    proxy_set_header Host $host:$server_port;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header REMOTE-HOST $remote_addr;
    proxy_connect_timeout 30s;
    proxy_read_timeout 86400s;
    proxy_send_timeout 30s;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
```

### 前台页面访问后台接口时代理转发给 CMS

```shell
location ~* ^/(editor|batch|views/ajax|entity_reference_autocomplete|taxonomy/([^/]+)/([^/]+)/edit|autocomplete|media-library|history|quickedit|webform_rest|session|contextual|themes|shs-term-data|modules|libraries|core|api|en/api|user|admin|manage|system|print|export|sites/([^/]+)/files|front-preview|dropzonejs|ckeditor_uploadimage/rest) {
    proxy_pass http://127.0.0.1:8090;
    proxy_redirect off;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host $server_name;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Port 443;
    proxy_read_timeout 240;
    # proxy_cache xinshi;
    # 要求nginx刷新内容时使用条件请求
    proxy_cache_revalidate on;
    # 访问几次才被缓存，可以确保最常访问的添加到项目中
    proxy_cache_min_uses 1;
    # 有效时间
    # 当后端故障时，提供缓存文件
    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    proxy_cache_background_update on;
    # 多个客户端请求缓存是miss,则仅允许第一个去去最新的数据，等缓存更新时，再去提取最新的缓存文件，可以防止未命中的直接发送后台
    proxy_cache_lock on;
    proxy_cache_methods GET HEAD;
    # 不缓存私有数据，url带有no_cache的也忽略
    proxy_cache_bypass $http_x_boost_fetch $arg_nocache $arg_preview $arg_no_cache $cookie_nocache;
    # nginx 当包含Expires没过期或者cache-control 带有private,no-cache,no-store, set-Cookies默认不会缓存响应
    # 检测缓存
    add_header X-Proxy-Cache $upstream_cache_status;
    proxy_buffering on;
    add_header Strict-Transport-Security "max-age=31536000";
    proxy_set_header Host $host;
    if ( $uri ~* "\.(gif|png|jpg|css|js|woff|woff2)$" ) {
        expires 1m;
    }
    proxy_ignore_headers Set-Cookie Cache-Control expires;
    proxy_cache proxy_cache_panel;
    proxy_cache_key $host$uri$is_args$args;
    proxy_cache_valid 200 304 301 302 10m;

}
```

## 配置DeepSeek

如果是Pro版本，有AI对话和生成组件等功能，访问/chart接口转发给DeepSeek node处理：

```shell
location  /chat{
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host:$server_port;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header REMOTE-HOST $remote_addr;
    proxy_connect_timeout 30s;
    proxy_read_timeout 86400s;
    proxy_send_timeout 30s;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    }
```

## Drupal 伪静态相关配置

```shell
if (!-e $request_filename) {
  rewrite ^ /index.php?$query_string last;
}
```

## 完整配置如下

```shell
location ~* ^/(editor|batch|views/ajax|entity_reference_autocomplete|taxonomy/([^/]+)/([^/]+)/edit|autocomplete|media-library|history|quickedit|webform_rest|session|contextual|themes|shs-term-data|modules|libraries|core|api|en/api|user|admin|manage|system|print|export|sites/([^/]+)/files|front-preview|dropzonejs|ckeditor_uploadimage/rest) {
    proxy_pass http://127.0.0.1:8090;
    proxy_redirect off;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host $server_name;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Port 443;
    proxy_read_timeout 240;
    # proxy_cache xinshi;
    # 要求nginx刷新内容时使用条件请求
    proxy_cache_revalidate on;
    # 访问几次才被缓存，可以确保最常访问的添加到项目中
    proxy_cache_min_uses 1;
    # 有效时间
    # 当后端故障时，提供缓存文件
    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    proxy_cache_background_update on;
    # 多个客户端请求缓存是miss,则仅允许第一个去去最新的数据，等缓存更新时，再去提取最新的缓存文件，可以防止未命中的直接发送后台
    proxy_cache_lock on;
    proxy_cache_methods GET HEAD;
    # 不缓存私有数据，url带有no_cache的也忽略
    proxy_cache_bypass $http_x_boost_fetch $arg_nocache $arg_preview $arg_no_cache $cookie_nocache;
    # nginx 当包含Expires没过期或者cache-control 带有private,no-cache,no-store, set-Cookies默认不会缓存响应
    # 检测缓存
    add_header X-Proxy-Cache $upstream_cache_status;
    proxy_buffering on;
    add_header Strict-Transport-Security "max-age=31536000";
    proxy_set_header Host $host;
    if ( $uri ~* "\.(gif|png|jpg|css|js|woff|woff2)$" ) {
        expires 1m;
    }
    proxy_ignore_headers Set-Cookie Cache-Control expires;
    proxy_cache proxy_cache_panel;
    proxy_cache_key $host$uri$is_args$args;
    proxy_cache_valid 200 304 301 302 10m;

}

location  /chat{
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host:$server_port;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header REMOTE-HOST $remote_addr;
    proxy_connect_timeout 30s;
    proxy_read_timeout 86400s;
    proxy_send_timeout 30s;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    }

location / {
    proxy_pass http://127.0.0.1:4201;
    proxy_set_header Host $host:$server_port;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header REMOTE-HOST $remote_addr;
    proxy_connect_timeout 30s;
    proxy_read_timeout 86400s;
    proxy_send_timeout 30s;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
```
